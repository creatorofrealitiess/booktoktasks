<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Booktok Tasks</title>
<meta name="theme-color" content="#0f0e11">
<meta name="apple-mobile-web-app-title" content="Booktok">
<link rel="apple-touch-icon" href="https://emojicdn.elk.sh/ðŸ“š?style=apple">

<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e11;
    --surface: #1a1820;
    --surface2: #221f2a;
    --border: #2e2a38;
    --accent: #c084fc;
    --accent2: #f0abfc;
    --accent-re: #f97316;
    --accent-dk: #60a5fa;
    --accent-pv: #34d399;
    --accent-sent: #fbbf24;
    --accent-post: #c084fc;
    --text: #f0edf8;
    --text-muted: #8b7fa8;
    --done-bg: #161420;
    --radius: 14px;
    --tab-h: 52px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    padding: 52px 20px 12px;
    background: linear-gradient(180deg, #1a0f2e 0%, var(--bg) 100%);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    font-style: italic;
    color: var(--accent2);
    letter-spacing: -0.3px;
  }

  .header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .sync-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .sync-btn:active { transform: scale(0.95); }
  .sync-btn.spinning { color: var(--accent); border-color: var(--accent); }

  /* â”€â”€ TABS â”€â”€ */
  .tabs-wrap {
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    display: flex;
    gap: 6px;
    padding-bottom: 2px;
  }
  .tabs-wrap::-webkit-scrollbar { display: none; }

  .tab {
    flex-shrink: 0;
    height: var(--tab-h);
    padding: 0 16px;
    border-radius: 12px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 7px;
    white-space: nowrap;
  }

  .tab .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: currentColor;
    opacity: 0.5;
  }

  .tab.active {
    border-color: var(--tab-color, var(--accent));
    color: var(--tab-color, var(--accent));
    background: var(--surface2);
  }
  .tab.active .dot { opacity: 1; }

  .tab .count {
    background: var(--surface2);
    color: var(--text-muted);
    font-size: 12px;
    padding: 1px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }
  .tab.active .count {
    background: var(--tab-color, var(--accent));
    color: #0f0e11;
    font-weight: 600;
  }

  /* â”€â”€ CONTENT â”€â”€ */
  .content {
    padding: 16px 16px 120px;
  }

  .list-panel { display: none; }
  .list-panel.active { display: block; }

  /* â”€â”€ SECTION HEADER â”€â”€ */
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 20px 0 10px;
  }

  .section-label {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .move-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--accent);
    background: none;
    border: 1px solid var(--accent);
    border-radius: 20px;
    padding: 4px 12px;
    cursor: pointer;
    opacity: 0.8;
    transition: all 0.2s;
  }
  .move-btn:active { transform: scale(0.95); opacity: 1; }

  .clear-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--text-muted);
    background: none;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .clear-btn:active { transform: scale(0.95); }

  /* â”€â”€ TASK CARD â”€â”€ */
  .task {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }

  .task::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--task-color, var(--accent));
    border-radius: 3px 0 0 3px;
  }

  .task.done {
    background: var(--done-bg);
    border-color: transparent;
    opacity: 0.6;
  }

  .task.done .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
  }

  /* Checkbox */
  .check {
    width: 26px; height: 26px;
    border-radius: 50%;
    border: 2px solid var(--task-color, var(--accent));
    flex-shrink: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 1px;
    transition: all 0.2s;
    background: transparent;
  }

  .task.done .check {
    background: var(--task-color, var(--accent));
    border-color: var(--task-color, var(--accent));
  }

  .check svg { display: none; }
  .task.done .check svg { display: block; }

  .task-body { flex: 1; min-width: 0; }

  .task-title {
    font-size: 17px;
    font-weight: 500;
    line-height: 1.4;
    color: var(--text);
    word-break: break-word;
  }

  .task-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    flex-wrap: wrap;
  }

  .task-due {
    font-size: 13px;
    color: var(--text-muted);
  }

  .task-due.overdue {
    color: var(--accent-re);
    font-weight: 600;
  }

  .task-due.today {
    color: var(--accent-pv);
    font-weight: 600;
  }

  .task-notes {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 3px;
    line-height: 1.4;
  }

  /* Delete button */
  .del-btn {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 16px;
    margin-top: -2px;
  }

  .task:hover .del-btn,
  .task:focus-within .del-btn { opacity: 1; }

  /* Show delete always on touch devices */
  @media (hover: none) {
    .del-btn { opacity: 0.4; }
  }

  /* â”€â”€ ADD TASK â”€â”€ */
  .add-wrap {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(0deg, var(--bg) 70%, transparent 100%);
    padding: 16px 16px 32px;
    z-index: 200;
  }

  .add-form {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    transition: border-color 0.2s;
  }

  .add-form:focus-within {
    border-color: var(--accent);
  }

  .add-input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    color: var(--text);
    min-width: 0;
  }

  .add-input::placeholder { color: var(--text-muted); }

  .add-date {
    background: none;
    border: none;
    outline: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--text-muted);
    width: 110px;
    cursor: pointer;
    color-scheme: dark;
  }

  .add-submit {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--accent);
    color: #0f0e11;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: transform 0.15s;
    font-weight: 300;
    line-height: 1;
  }
  .add-submit:active { transform: scale(0.9); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-muted);
  }

  .empty-icon { font-size: 36px; margin-bottom: 10px; }
  .empty-text { font-size: 14px; }

  /* â”€â”€ LOADING â”€â”€ */
  .loading {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999;
    gap: 16px;
    transition: opacity 0.4s;
  }

  .loading.hide { opacity: 0; pointer-events: none; }

  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-family: 'DM Serif Display', serif;
    font-style: italic;
    color: var(--text-muted);
    font-size: 16px;
  }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 13px;
    padding: 10px 18px;
    border-radius: 20px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
    z-index: 300;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">loading your lists...</div>
</div>

<div class="header">
  <div class="header-row">
    <h1>ðŸ“š booktok</h1>
    <button class="sync-btn" id="syncBtn" onclick="syncNow()">â†» sync</button>
  </div>
  <div class="tabs-wrap" id="tabsWrap"></div>
</div>

<div class="content" id="content"></div>

<div class="add-wrap">
  <div class="add-form">
    <input class="add-input" id="addInput" type="text" placeholder="Add a taskâ€¦" autocomplete="off">
    <input class="add-date" id="addDate" type="date">
    <button class="add-submit" onclick="addTask()">+</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LISTS = [
  { key: "batch_RE", label: "Batch (RE)", color: "var(--accent-re)" },
  { key: "batch_DK", label: "Batch (DK)", color: "var(--accent-dk)" },
  { key: "batch_PV", label: "Batch (PV)", color: "var(--accent-pv)" },
  { key: "sent_RE",  label: "Sent (RE)",  color: "var(--accent-sent)" },
  { key: "sent_DK",  label: "Sent (DK)",  color: "var(--accent-sent)" },
  { key: "sent_PV",  label: "Sent (PV)",  color: "var(--accent-sent)" },
  { key: "post",     label: "Posting",    color: "var(--accent-post)" },
];

let state = { tasks: {}, completed: {} };
let activeTab = LISTS[0].key;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function() {
  // Set today's date as default in the add form
  document.getElementById("addDate").value = todayStr();
  buildTabs();
  loadData();
};

function loadData() {
  google.script.run
    .withSuccessHandler(function(data) {
      state = data;
      render();
      document.getElementById("loading").classList.add("hide");
    })
    .withFailureHandler(function(err) {
      showToast("Error loading: " + err.message);
      document.getElementById("loading").classList.add("hide");
    })
    .getAllData();
}

function syncNow() {
  const btn = document.getElementById("syncBtn");
  btn.classList.add("spinning");
  btn.textContent = "â†» syncingâ€¦";
  google.script.run
    .withSuccessHandler(function(data) {
      state = data;
      render();
      btn.classList.remove("spinning");
      btn.textContent = "â†» sync";
      showToast("Synced with calendar âœ“");
    })
    .withFailureHandler(function(err) {
      btn.classList.remove("spinning");
      btn.textContent = "â†» sync";
      showToast("Sync failed");
    })
    .forceSync();
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabs() {
  const wrap = document.getElementById("tabsWrap");
  wrap.innerHTML = LISTS.map(list => `
    <button class="tab ${list.key === activeTab ? 'active' : ''}"
      style="--tab-color: ${list.color}"
      onclick="switchTab('${list.key}')">
      <span class="dot"></span>
      ${list.label}
      <span class="count" id="count_${list.key}">0</span>
    </button>
  `).join("");
}

function switchTab(key) {
  activeTab = key;
  document.querySelectorAll(".tab").forEach((t, i) => {
    t.classList.toggle("active", LISTS[i].key === key);
  });
  document.querySelectorAll(".list-panel").forEach(p => {
    p.classList.toggle("active", p.dataset.key === key);
  });
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const content = document.getElementById("content");
  content.innerHTML = "";

  LISTS.forEach(list => {
    const tasks     = state.tasks[list.key]     || [];
    const completed = state.completed[list.key] || [];

    // Update tab count (active tasks only)
    const countEl = document.getElementById("count_" + list.key);
    if (countEl) countEl.textContent = tasks.length;

    const panel = document.createElement("div");
    panel.className = "list-panel" + (list.key === activeTab ? " active" : "");
    panel.dataset.key = list.key;

    // Active tasks
    if (tasks.length === 0 && completed.length === 0) {
      panel.innerHTML = `
        <div class="empty">
          <div class="empty-icon">âœ¨</div>
          <div class="empty-text">All clear!</div>
        </div>`;
    } else {
      // Section header for active tasks
      if (tasks.length > 0) {
        const activeHead = document.createElement("div");
        activeHead.className = "section-head";
        activeHead.innerHTML = `
          <span class="section-label">To Do Â· ${tasks.length}</span>
          <button class="move-btn" onclick="moveCompleted('${list.key}')">Move completed â†“</button>
        `;
        panel.appendChild(activeHead);

        tasks.forEach(task => {
          panel.appendChild(renderTask(task, list, false));
        });
      }

      // Completed tasks
      if (completed.length > 0) {
        const doneHead = document.createElement("div");
        doneHead.className = "section-head";
        doneHead.style.marginTop = tasks.length > 0 ? "24px" : "0";
        doneHead.innerHTML = `
          <span class="section-label">Completed Â· ${completed.length}</span>
          <button class="clear-btn" onclick="clearCompleted('${list.key}')">Clear all</button>
        `;
        panel.appendChild(doneHead);

        completed.forEach(task => {
          panel.appendChild(renderTask(task, list, true));
        });
      }
    }

    content.appendChild(panel);
  });
}

function renderTask(task, list, isDone) {
  const div = document.createElement("div");
  div.className = "task" + (isDone ? " done" : "");
  div.style.setProperty("--task-color", list.color);
  div.dataset.id = task.id;

  const dueLabel = formatDueLabel(task.due);
  const dueClass = getDueClass(task.due, isDone);

  div.innerHTML = `
    <div class="check" onclick="toggleTask('${list.key}', '${task.id}')">
      <svg width="12" height="9" viewBox="0 0 12 9" fill="none">
        <path d="M1 4L4.5 7.5L11 1" stroke="#0f0e11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="task-body">
      <div class="task-title">${escHtml(task.title)}</div>
      <div class="task-meta">
        <span class="task-due ${dueClass}">${dueLabel}</span>
      </div>
      ${task.notes ? `<div class="task-notes">${escHtml(task.notes)}</div>` : ""}
    </div>
    <button class="del-btn" onclick="deleteTask('${list.key}', '${task.id}')">Ã—</button>
  `;

  return div;
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTask(listKey, taskId) {
  // Optimistic UI update
  const tasks     = state.tasks[listKey]     || [];
  const completed = state.completed[listKey] || [];

  const activeIdx = tasks.findIndex(t => t.id === taskId);
  if (activeIdx !== -1) {
    const task = tasks.splice(activeIdx, 1)[0];
    task.completedAt = new Date().toISOString();
    completed.push(task);
  } else {
    const doneIdx = completed.findIndex(t => t.id === taskId);
    if (doneIdx !== -1) {
      const task = completed.splice(doneIdx, 1)[0];
      delete task.completedAt;
      tasks.push(task);
      tasks.sort((a, b) => new Date(a.due) - new Date(b.due));
    }
  }

  state.tasks[listKey]     = tasks;
  state.completed[listKey] = completed;
  render();

  // Persist to backend
  google.script.run
    .withFailureHandler(() => showToast("Save failed â€” try again"))
    .toggleTask(listKey, taskId);
}

function addTask() {
  const input = document.getElementById("addInput");
  const date  = document.getElementById("addDate");
  const title = input.value.trim();
  if (!title) return;

  const task = {
    id: "manual_" + Date.now(),
    title: title,
    due: date.value || todayStr(),
    notes: "",
    manual: true,
  };

  if (!state.tasks[activeTab]) state.tasks[activeTab] = [];
  state.tasks[activeTab].push(task);
  state.tasks[activeTab].sort((a, b) => new Date(a.due) - new Date(b.due));

  input.value = "";
  render();

  google.script.run
    .withFailureHandler(() => showToast("Save failed â€” try again"))
    .addTask(activeTab, task.title, task.due);
}

function deleteTask(listKey, taskId) {
  state.tasks[listKey]     = (state.tasks[listKey]     || []).filter(t => t.id !== taskId);
  state.completed[listKey] = (state.completed[listKey] || []).filter(t => t.id !== taskId);
  render();

  google.script.run
    .withFailureHandler(() => showToast("Delete failed â€” try again"))
    .deleteTask(listKey, taskId);
}

function moveCompleted(listKey) {
  // Tasks are already in completed store when checked off â€” this is just a visual cue
  // In our model, checking off already moves them. So this button re-renders to make
  // sure everything checked is showing in the completed section.
  render();
  showToast("Done tasks are below âœ“");
}

function clearCompleted(listKey) {
  state.completed[listKey] = [];
  render();
  google.script.run
    .withFailureHandler(() => showToast("Clear failed"))
    .clearCompleted(listKey);
}

// Allow pressing Enter to add task
document.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && document.activeElement.id === "addInput") {
    addTask();
  }
});

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr() {
  const d = new Date();
  return d.getFullYear() + "-" +
    String(d.getMonth()+1).padStart(2,"0") + "-" +
    String(d.getDate()).padStart(2,"0");
}

function formatDueLabel(dateStr) {
  if (!dateStr) return "";
  const today = todayStr();
  const [y, m, d] = dateStr.split("-").map(Number);
  const due = new Date(y, m-1, d);
  const now = new Date();
  now.setHours(0,0,0,0);
  const diff = Math.round((due - now) / 86400000);

  if (diff < 0)  return "Overdue Â· " + fmtDate(dateStr);
  if (diff === 0) return "Today";
  if (diff === 1) return "Tomorrow";
  if (diff < 7)  return fmtDate(dateStr, true); // show day name
  return fmtDate(dateStr);
}

function getDueClass(dateStr, isDone) {
  if (isDone) return "";
  const today = todayStr();
  const [y, m, d] = dateStr.split("-").map(Number);
  const due = new Date(y, m-1, d);
  const now = new Date();
  now.setHours(0,0,0,0);
  const diff = Math.round((due - now) / 86400000);
  if (diff < 0) return "overdue";
  if (diff === 0) return "today";
  return "";
}

function fmtDate(dateStr, short) {
  const [y, m, d] = dateStr.split("-").map(Number);
  const date = new Date(y, m-1, d);
  if (short) return date.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
}

function escHtml(str) {
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2500);
}
</script>
</body>
</html>
